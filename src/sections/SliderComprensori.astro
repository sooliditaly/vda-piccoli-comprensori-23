---
import { Image } from "astro:assets";

import brussonImage from "../images/card-brusson.webp";
import valgrisencheImage from "../images/card-valgrisenche.webp";
import remesImage from "../images/card-remes.webp";
import antagnodImage from "../images/card-antagnod.webp";
import chamoisImage from "../images/card-chamois.webp";
import champorcherImage from "../images/card-champorcher.webp";
import cogneImage from "../images/card-cogne.webp";
import crevacolImage from "../images/card-crevacol.webp";
import gressoneyImage from "../images/card-gressoney.webp";
import magdeleineImage from "../images/card-magdeleine.webp";
import ollomontImage from "../images/card-ollomont.webp";

import iconBrussonImage from "../images/icon-brusson.svg";
import iconValgrisencheImage from "../images/icon-valgrisenche.svg";
import iconRemesImage from "../images/icon-remes.svg";
import iconChamporcherImage from "../images/icon-champorcher.svg";
import iconCogneImage from "../images/icon-cogne.svg";
import iconOllomontImage from "../images/icon-ollomont.svg";
import iconAntagnodImage from "../images/icon-antagnod.svg";
import iconChamoisImage from "../images/icon-chamois.svg";
import iconMagdeleineImage from "../images/icon-magdeleine.svg";
import iconGressoneyImage from "../images/icon-gressoney.svg";
import iconCrevacolImage from "../images/icon-crevacol.svg";

const parallaxPercentage = "20%";

// import Swiper and modules styles
import "swiper/css";
import "swiper/css/navigation";

import { loadTranslations } from "../utils/loadTranslations";
const { lang, activeSlug = "", skipIntro = false } = Astro.props;
const translations = loadTranslations(lang);

const baseUrl = lang === "it" ? "" : `/${lang}`;
const pathSegment = lang === "it" ? "comprensorio" : lang === "en" ? "resort" : "station";

const comprensoriSlugMap = {
	brusson: "brusson",
	valgrisenche: "valgrisenche",
	"rhemes-notre-dame": "rhemes-notre-dame",
	champorcher: "champorcher",
	cogne: "cogne",
	ollomont: "ollomont",
	antagnod: "antagnod",
	chamois: "chamois",
	"la-magdeleine": "la-magdeleine",
	"gressoney-saint-jean": "gressoney-saint-jean",
	crevacol: "crevacol"
};
---

<script>
	declare const dataLayer: any;
	declare const fbq: (...args: any[]) => void;
	declare const usermaven: any;

	// Helper function to get current_lang from dataLayer
	const getCurrentLang = () => {
		if (window.dataLayer && window.dataLayer.length > 0) {
			for (let i = window.dataLayer.length - 1; i >= 0; i--) {
				if (window.dataLayer[i].current_lang) {
					return window.dataLayer[i].current_lang;
				}
			}
		}
		return "it"; // fallback
	};
	// core version + navigation modules:
	import Swiper from "swiper";
	import { Manipulation, Navigation, Parallax } from "swiper/modules";

	const swiperContainer = document.querySelector<HTMLElement>(".swiper");
	const activeSlug = swiperContainer?.dataset.activeSlug || "";
	const shouldLoop = swiperContainer?.dataset.loop === "true";

	const swiper = new Swiper(".swiper", {
		// Optional parameters
		direction: "horizontal",
		loop: shouldLoop,
		modules: [Navigation, Parallax, Manipulation],
		parallax: true,

		slidesPerView: "auto",
		centeredSlides: true,
		spaceBetween: 15,

		// Navigation arrows
		navigation: {
			nextEl: ".swiper-button-next",
			prevEl: ".swiper-button-prev"
		},
		breakpoints: {
			// when window width is >= 750px
			750: {
				initialSlide: 0,
				loop: shouldLoop,
				centeredSlides: shouldLoop,
				spaceBetween: 20,
				grabCursor: true,
				loopAdditionalSlides: 3
			}
		}
	});

	if (activeSlug) {
		const slides = Array.from(document.querySelectorAll<HTMLElement>(".swiper-slide.comprensorio:not(.swiper-slide-duplicate)"));
		const activeSlide = slides.find((slide) => slide.dataset.slug === activeSlug);

		if (activeSlide) {
			activeSlide.classList.add("is-active");

			const realIndex = activeSlide.dataset.swiperSlideIndex ? parseInt(activeSlide.dataset.swiperSlideIndex, 10) : slides.indexOf(activeSlide);

			if (realIndex >= 0) {
				swiper.params.centeredSlides = true;

				if (swiper.params.breakpoints?.[750]) {
					swiper.params.breakpoints[750].centeredSlides = true;
				}

				// Aggiorna Swiper dopo che gli stili CSS sono stati applicati
				setTimeout(() => {
					swiper.update();
					if (swiper.params.loop) {
						swiper.slideToLoop(realIndex, 0);
					} else {
						swiper.slideTo(realIndex, 0);
					}
				}, 50);
			}
		}
	}

	window.addEventListener("DOMContentLoaded", () => {
		document.querySelectorAll(".comprensorio").forEach(($element) => {
			const link = $element.querySelector("a");
			const href = link?.getAttribute("href");

			$element.addEventListener("click", (e) => {
				const nomeComprensorio = $element.querySelector("h2").innerText;
				const currentLang = getCurrentLang();

				// send event to Google Tag Manager (slider-specific, current_lang is already in dataLayer)
				dataLayer.push({
					event: "click_cta-comprensorio-slider",
					nome_comprensorio: nomeComprensorio,
					source: "slider"
				});

				// send event to UserMaven (slider-specific)
				usermaven("track", "click_cta-comprensorio-slider", {
					comprensorio: nomeComprensorio,
					lingua: currentLang
				});

				// send event to Facebook Pixel (slider-specific)
				fbq("trackCustom", "click_cta-comprensorio-slider", {
					nome_comprensorio: nomeComprensorio,
					source: "slider",
					lingua: currentLang
				});

				// Navigate to the link
				if (href) {
					window.location.href = href;
				}
			});
		});
	});
</script>

<style>

	:root {
		--comp-slide-height: 60vh;
	}

	.swiper {
		width: 100%;
		overflow: hidden;
	}

	.swiper-wrapper {
		align-items: flex-end;
		padding-bottom: calc((var(--comp-slide-height) * 1.15 - var(--comp-slide-height)) / 2);
	}

	@media (min-width: 750px) {
		.swiper-wrapper {
			padding-bottom: calc((var(--comp-slide-height) * 1.15 - var(--comp-slide-height)) / 2);
		}
	}

	.slider-intro {
		padding: 0 var(--margin-small);
	}

	.swiper-slide.desktop-only h2 {
		color: var(--azzurro);
		max-width: 40rem;
	}

	.slider-intro p {
		margin-top: 0;
	}

	.swiper-slide {

		display: flex;
		flex-direction: column;
		align-items: center;

		height: 90vh;
		width: 70vw;
		max-width: 28rem;
		max-height: var(--comp-slide-height);

		padding: 2rem;
		padding-bottom: var(--margin-standard);

		overflow: hidden;

		user-select: none;

	}

	.swiper-slide h2 {
		font-size: 2.8rem;
	}

	.swiper-slide.desktop-only {
		display: none;
	}

	.swiper-slide.mobile-only {
		display: none;
	}

	@media (min-width: 750px) {
		.swiper-slide {
			width: 83vw;
			max-width: 36rem;
		}

		.swiper-slide h2 {
			font-size: 3.4rem;
		}

		.swiper-slide.desktop-only {
			display: block;
			align-items: self-start;
		}

		.swiper-slide.mobile-only {
			display: none;
		}
	}

	.swiper-slide:first-child p {
		margin-bottom: var(--margin-small);
	}

	.swiper-slide.slider-intro p {
		margin-bottom: var(--margin-small);
	}

	.swiper-slide h2 {
		color: white;
		font-family: "Ramen";
		margin: var(--margin-small) 0;
	}

	.swiper-slide &:first-child {
		text-align: left;
		padding-left: 0;
		width: 80vw;
	}

	.swiper-slide.comprensorio {
		color: white;
		cursor: pointer;
		transition:
			width 0.3s ease,
			height 0.3s ease;
	}

	.swiper-slide.comprensorio.is-active {
		width: calc(70vw * 1.15);
		height: calc(90vh * 1.15);
		max-width: calc(28rem * 1.15);
		max-height: calc(60rem * 1.15);
		margin-bottom: calc((90vh * 1.15 - 90vh) / 2 * -1);
		z-index: 10;
	}

	@media (min-width: 750px) {
		.swiper-slide.comprensorio.is-active {
			width: calc(83vw * 1.15);
			max-width: calc(36rem * 1.15);
			margin-bottom: calc((60rem * 1.15 - 60rem) / 2 * -1);
		}
	}

	.swiper-slide.comprensorio.is-active .card-parallax-background {
		height: calc(60rem * 1.15);
	}

	.swiper-slide.comprensorio.is-active .card-parallax-background .gradient-overlay {
		height: calc(60rem * 1.15);
	}

	.swiper-slide.comprensorio.is-active .card-parallax-background img {
		height: calc(60rem * 1.15);
	}

	.swiper-slide.comprensorio h1 {
		color: white;
	}

	.swiper-slide.comprensorio .icon-title-group {
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		gap: var(--margin-small);
		flex: 1;
	}

	.swiper-slide.comprensorio .icon-title-group img {
		margin-bottom: 0;
	}

	.swiper-slide.comprensorio .icon-title-group h2 {
		margin: 0;
	}

	/* .swiper-slide.comprensorio p {
		font-size: 1.5rem;
		margin: 0;
		min-height: 18rem;
	} */

	.card-parallax-background {
		position: absolute;
		z-index: -1;
		top: 0;
		height: 60rem;
	}

	.card-parallax-background .gradient-overlay {
		left: 0;
		top: 0;
		position: absolute;

		height: 60rem;
		width: 100%;
		background: rgba(32, 75, 102, 0.5);
		background: linear-gradient(0deg, rgba(17, 31, 54, 1) 0%, rgba(17, 31, 54, 0) 84%);
	}

	.card-parallax-background img {
		height: 60rem;
		width: auto;

		max-inline-size: none;
		max-block-size: none;
	}

	@media (min-width: 750px) {
		.swiper-slide.slider-intro {
			justify-content: center;
			text-align: left;
			padding-left: 0;
			width: 80vw;
			max-width: 800px;

			padding-left: var(--margin-large);
			padding-right: var(--margin-large);
		}
	}
</style>

<section class="lasciati-ispirare">
	{
		!skipIntro && (
			<div class="slider-intro mobile-only">
				<div>
					<h1 set:html={translations.lasciati_ispirare_title} />
					<p set:html={translations.lasciati_ispirare_p} />
					<a href={translations.link_skiperformance} class="btn" id="cta-acquista-section-lasciati-ispirare" target="_blank">
						{translations.acquista_online}
					</a>
				</div>
			</div>
		)
	}

	<section class="slider-comprensori">
		<div class="swiper" data-active-slug={activeSlug} data-loop={skipIntro ? "true" : "false"}>
			<div class="swiper-wrapper">
				{
					!skipIntro && (
						<div class="swiper-slide slider-intro desktop-only">
							<h1 set:html={translations.lasciati_ispirare_title} />
							<p set:html={translations.lasciati_ispirare_p} />
							<a href={translations.link_skiperformance} class="btn" id="cta-acquista-section-lasciati-ispirare" target="_blank">
								{translations.acquista_online}
							</a>
						</div>
					)
				}

				<div class="swiper-slide comprensorio" data-slug="brusson">
					<div class="card-parallax-background" data-swiper-parallax-x={parallaxPercentage}>
						<Image src={brussonImage} alt="Panorama Brusson" widths={[600, 1190]} width="600" height="600" loading="eager" />
						<div class="gradient-overlay"></div>
					</div>
					<div class="icon-title-group">
						<Image src={iconBrussonImage} alt="Illustrazione Brusson" width="84" height="82" />
						<h2>Brusson</h2>
					</div>
					{/* <p set:html={translations.brusson} /> */}
					<a href={`${baseUrl}/${pathSegment}/${comprensoriSlugMap["brusson"]}`} class="btn btn--secondary" data-astro-reload="false" style="pointer-events: none;">{translations.scopri}</a>
				</div>

				<div class="swiper-slide comprensorio" data-slug="valgrisenche">
					<div class="card-parallax-background" data-swiper-parallax-x={parallaxPercentage}>
						<Image src={valgrisencheImage} alt="Panorama Valgrisenche" widths={[600, 1190]} width="600" height="600" loading="eager" />
						<div class="gradient-overlay"></div>
					</div>
					<div class="icon-title-group">
						<Image src={iconValgrisencheImage} alt="Illustrazione Valgrisenche" width="136" height="82" />
						<h2>VALGRISENCHE</h2>
					</div>
					{/* <p set:html={translations.valgrisenche} /> */}
					<a href={`${baseUrl}/${pathSegment}/${comprensoriSlugMap["valgrisenche"]}`} class="btn btn--secondary" data-astro-reload="false" style="pointer-events: none;">{translations.scopri}</a>
				</div>

				<div class="swiper-slide comprensorio" data-slug="rhemes-notre-dame">
					<div class="card-parallax-background" data-swiper-parallax-x={parallaxPercentage}>
						<Image src={remesImage} alt="Panorama Rhêmes Notre Dame" widths={[600, 1190]} width="600" height="600" loading="eager" />
						<div class="gradient-overlay"></div>
					</div>
					<div class="icon-title-group">
						<Image src={iconRemesImage} alt="Illustrazione Rhêmes Notre Dame" width="60" height="90" />
						<h2>Rhêmes <br />Notre Dame</h2>
					</div>
					{/* <p set:html={translations.rhemes_notre_dame} /> */}
					<a href={`${baseUrl}/${pathSegment}/${comprensoriSlugMap["rhemes-notre-dame"]}`} class="btn btn--secondary" data-astro-reload="false" style="pointer-events: none;">{translations.scopri}</a>
				</div>

				<div class="swiper-slide comprensorio" data-slug="champorcher">
					<div class="card-parallax-background" data-swiper-parallax-x={parallaxPercentage}>
						<Image src={champorcherImage} alt="Panorama Champorcher" widths={[600, 1190]} width="600" height="600" loading="eager" />
						<div class="gradient-overlay"></div>
					</div>
					<div class="icon-title-group">
						<Image src={iconChamporcherImage} alt="Illustrazione Champorcher" width="96" height="64" />
						<h2>CHAMPORCHER</h2>
					</div>
					{/* <p set:html={translations.champorcher} /> */}
					<a href={`${baseUrl}/${pathSegment}/${comprensoriSlugMap["champorcher"]}`} class="btn btn--secondary" data-astro-reload="false" style="pointer-events: none;">{translations.scopri}</a>
				</div>

				<div class="swiper-slide comprensorio" data-slug="cogne">
					<div class="card-parallax-background" data-swiper-parallax-x={parallaxPercentage}>
						<Image src={cogneImage} alt="Panorama Cogne" widths={[600, 1190]} width="600" height="600" loading="eager" />
						<div class="gradient-overlay"></div>
					</div>
					<div class="icon-title-group">
						<Image src={iconCogneImage} alt="Illustrazione Cogne" width="75" height="88" />
						<h2>COGNE</h2>
					</div>
					{/* <p set:html={translations.cogne} /> */}
					<a href={`${baseUrl}/${pathSegment}/${comprensoriSlugMap["cogne"]}`} class="btn btn--secondary" data-astro-reload="false" style="pointer-events: none;">{translations.scopri}</a>
				</div>

				<div class="swiper-slide comprensorio" data-slug="ollomont">
					<div class="card-parallax-background" data-swiper-parallax-x={parallaxPercentage}>
						<Image src={ollomontImage} alt="Panorama Ollomont" widths={[600, 1190]} width="600" height="600" loading="eager" />
						<div class="gradient-overlay"></div>
					</div>
					<div class="icon-title-group">
						<Image src={iconOllomontImage} alt="Illustrazione Ollomont" width="96" height="64" style="height: 100px; width: auto;" />
						<h2>Ollomont</h2>
					</div>
					{/* <p set:html={translations.ollomont} /> */}
					<a href={`${baseUrl}/${pathSegment}/${comprensoriSlugMap["ollomont"]}`} class="btn btn--secondary" data-astro-reload="false" style="pointer-events: none;">{translations.scopri}</a>
				</div>

				<div class="swiper-slide comprensorio" data-slug="antagnod">
					<div class="card-parallax-background" data-swiper-parallax-x={parallaxPercentage}>
						<Image src={antagnodImage} alt="Panorama Antagnod" widths={[600, 1190]} width="600" height="600" loading="eager" />
						<div class="gradient-overlay"></div>
					</div>
					<div class="icon-title-group">
						<Image src={iconAntagnodImage} alt="Illustrazione Antagnod" width="87" height="80" />
						<h2>Antagnod</h2>
					</div>
					{/* <p set:html={translations.antagnod} /> */}
					<a href={`${baseUrl}/${pathSegment}/${comprensoriSlugMap["antagnod"]}`} class="btn btn--secondary" data-astro-reload="false" style="pointer-events: none;">{translations.scopri}</a>
				</div>

				<div class="swiper-slide comprensorio" data-slug="chamois">
					<div class="card-parallax-background" data-swiper-parallax-x={parallaxPercentage}>
						<Image src={chamoisImage} alt="Panorama Chamois" widths={[600, 1190]} width="600" height="600" loading="eager" />
						<div class="gradient-overlay"></div>
					</div>
					<div class="icon-title-group">
						<Image src={iconChamoisImage} alt="Illustrazione Chamois" width="68" height="95" />
						<h2>Chamois</h2>
					</div>
					{/* <p set:html={translations.chamois} /> */}
					<a href={`${baseUrl}/${pathSegment}/${comprensoriSlugMap["chamois"]}`} class="btn btn--secondary" data-astro-reload="false" style="pointer-events: none;">{translations.scopri}</a>
				</div>

				<div class="swiper-slide comprensorio" data-slug="la-magdeleine">
					<div class="card-parallax-background" data-swiper-parallax-x={parallaxPercentage}>
						<Image src={magdeleineImage} alt="Panorama Magdeleine" widths={[600, 1190]} width="600" height="600" loading="eager" />
						<div class="gradient-overlay"></div>
					</div>
					<div class="icon-title-group">
						<Image src={iconMagdeleineImage} alt="Illustrazione Magdeleine" width="98" height="80" />
						<h2>La magdeleine</h2>
					</div>
					{/* <p set:html={translations.la_magdeleine} /> */}
					<a href={`${baseUrl}/${pathSegment}/${comprensoriSlugMap["la-magdeleine"]}`} class="btn btn--secondary" data-astro-reload="false" style="pointer-events: none;">{translations.scopri}</a>
				</div>

				<div class="swiper-slide comprensorio" data-slug="gressoney-saint-jean">
					<div class="card-parallax-background" data-swiper-parallax-x={parallaxPercentage}>
						<Image src={gressoneyImage} alt="Panorama Gressoney Saint Jean" widths={[600, 1190]} width="600" height="600" loading="eager" />
						<div class="gradient-overlay"></div>
					</div>
					<div class="icon-title-group">
						<Image src={iconGressoneyImage} alt="Illustrazione Gressoney Saint Jean" width="74" height="80" />
						<h2>Gressoney saint jean</h2>
					</div>
					{/* <p set:html={translations.gressoney_saint_jean} /> */}
					<a href={`${baseUrl}/${pathSegment}/${comprensoriSlugMap["gressoney-saint-jean"]}`} class="btn btn--secondary" data-astro-reload="false" style="pointer-events: none;">{translations.scopri}</a>
				</div>

				<div class="swiper-slide comprensorio" data-slug="crevacol">
					<div class="card-parallax-background" data-swiper-parallax-x={parallaxPercentage}>
						<Image src={crevacolImage} alt="Panorama Crevacol" widths={[600, 1190]} width="600" height="600" loading="eager" />
						<div class="gradient-overlay"></div>
					</div>
					<div class="icon-title-group">
						<Image src={iconCrevacolImage} alt="Illustrazione Crevacol" width="102" height="70" />
						<h2>CRÉVACOL</h2>
					</div>
					{/* <p set:html={translations.crevacol} /> */}
					<a href={`${baseUrl}/${pathSegment}/${comprensoriSlugMap["crevacol"]}`} class="btn btn--secondary" data-astro-reload="false" style="pointer-events: none;">{translations.scopri}</a>
				</div>
			</div>
		</div>
	</section>
</section>
