---
import { Image } from "astro:assets";

import logoSkiLife from "../images/ski-life-logo.svg";
import arrowDownImage from "../images/icon-arrow-down.svg";

import { loadTranslations } from "../utils/loadTranslations";
const { lang } = Astro.props;
const translations = loadTranslations(lang);
---

<style>
	.lang-switch {
		position: absolute;
		display: flex;
		top: var(--margin-small);
		right: var(--margin-small);
		width: 130px;
		justify-content: space-around;
	}

	.lang-switch .separator {
		border-right: 2px solid white;
	}

	.lang-switch a {
		color: white;
		font-size: 1.5rem;
		font-weight: 700;
		display: inline-block;
		display: block;
	}

	.lang-switch a:hover {
		text-decoration: underline;
	}

	.lang-switch a.selected {
		text-decoration: underline;
	}

	header {
		color: white;
		text-align: center;
		background-image: url(../images/bg-header-mobile@1x.webp);
		background-size: 100% auto;
		background-position: bottom;
		background-size: cover;
	}

	header .content {
		padding-top: calc(var(--margin-standard) * 1.5);
		padding-bottom: var(--margin-small);
		display: flex;
		flex-direction: column;
		justify-content: space-between;

		margin: 0 auto;
		height: 90vh;
		max-height: 90rem;
	}

	header .btn {
		display: inline-block;
	}

	header .arrow-down {
		margin: 0 auto;
		width: 30px;
		height: auto;
	}

	@media (min-width: 750px) {
		.lang-switch {
			position: relative;
			align-self: flex-end;
			width: 150px;
			margin-bottom: -4rem;
		}

		.lang-switch {
			background-color: var(--azzurro);
			padding: 10px;
			/* border: 2px solid white; */
			border-radius: 0.6rem;
		}

		header {
			background-image: url(../images/bg-header-desktop@1x.webp);
		}

		header .content {
			padding-top: var(--margin-standard);
			padding-bottom: var(--margin-standard);
			align-items: center;
			height: auto;
		}

		header .content img {
			align-self: flex-start;
			margin: 0;
			margin-bottom: var(--margin-standard);
			width: 261px;
		}

		header .arrow-down {
			display: none;
		}
	}

	header .logo {
		max-width: 15rem;
		height: auto;
		aspect-ratio: 13 / 6;
		display: block;
		margin: 0 auto;
	}

	header small,
	header strong {
		display: block;
	}

	header button {
		display: block;

		margin-left: auto;
		margin-right: auto;

		margin-top: var(--margin-small);
		margin-bottom: var(--margin-small);
	}

	header button,
	header .btn {
		min-width: 240px;
		margin-left: auto;
		margin-right: auto;
		cursor: pointer;
	}

	header small {
		font-size: 2rem;
		font-weight: bold;
		line-height: 1.2;
		margin-bottom: var(--margin-smallest);
	}

	header strong {
		font-family: "Ramen";
		font-size: 3rem;
		line-height: 1.2;
		margin-bottom: var(--margin-standard);
	}

	@media (min-width: 750px) {
		header .logo {
			max-width: 18rem;
			height: auto;
			aspect-ratio: 13 / 6;
			display: block;
			margin: 0 auto;
		}

		header small {
			font-size: 2.2rem;
			font-weight: bold;
			line-height: 1.2;
			margin-bottom: var(--margin-smallest);
		}

		header strong {
			font-family: "Ramen";
			font-size: 5.8rem;
			line-height: 1.2;
			margin-bottom: var(--margin-standard);
		}

		header .content {
			padding-top: calc(var(--margin-small));
		}
	}
</style>

<header>
	<div class="content">
		<div class="lang-switch">
			<a href="/" class={lang == "it" ? "selected" : ""}>IT</a>
			<span class="separator"></span>
			<a href="/en" class={lang == "en" ? "selected" : ""}>EN</a>
			<span class="separator"></span>
			<a href="/fr" class={lang == "fr" ? "selected" : ""}>FR</a>
		</div>

		<Image src={logoSkiLife} alt={translations.alt_ski_life} class="logo" loading="eager" />

		<div>
			<div>
				<small set:html={translations.scopri_la_magia} />
				<strong set:html={translations.piccoli_comprensori} />
			</div>

			<a href={translations.link_skiperformance} class="btn" id="cta-acquista-header" target="_blank">{translations.acquista_online}</a>
			<br />
			<button class="btn btn--secondary scopri-di-piu">{translations.scopri_borghi}</button>
		</div>

		<Image src={arrowDownImage} alt={translations.alt_vai_giu} class="arrow-down" loading="eager" />
	</div>

	<script>
		declare const dataLayer: any;
		declare const fbq: (...args: any[]) => void;
		declare const usermaven: any;

		// Helper function to get current_lang from dataLayer
		const getCurrentLang = () => {
			if (window.dataLayer && window.dataLayer.length > 0) {
				for (let i = window.dataLayer.length - 1; i >= 0; i--) {
					if (window.dataLayer[i].current_lang) {
						return window.dataLayer[i].current_lang;
					}
				}
			}
			return "it"; // fallback
		};

		const scrollLink = document.querySelector(".arrow-down"),
			targetElement = document.querySelector(".intro"),
			scopriElement = document.querySelector(".scopri-di-piu"),
			sliderElement = document.querySelector(".slider-comprensori"),
			mosaicoGridElement = document.querySelector(".mosaico-grid"),
			comprensoriMobileElement = document.querySelector(".comprensori-mobile"),
			comprensoriDesktopElement = document.querySelector(".comprensori-desktop"),
			acquistaHeaderElement = document.querySelector("#cta-acquista-header"),
			acquistaComeElement = document.querySelector("#cta-acquista-section-come"),
			acquistaCoseElement = document.querySelector("#cta-acquista-section-cose"),
			acquistaLasciatiIspirareElement = document.querySelector("#cta-acquista-section-lasciati-ispirare"),
			footerTelLinkElement = document.querySelector("#footer-tel-link"),
			footerEmailLinkElement = document.querySelector("#footer-email-link");

		scrollLink.addEventListener("click", function (e) {
			e.preventDefault();
			window.scroll({
				top: targetElement.offsetTop - 50,
				left: 0,
				behavior: "smooth"
			});
		});

		scopriElement.addEventListener("click", function (e) {
			e.preventDefault();
			const currentLang = getCurrentLang();

			dataLayer.push({
				event: "click_cta-lasciati-ispirare-header"
			});

			usermaven("track", "click_cta-lasciati-ispirare-header", {
				lingua: currentLang
			});

			// Cerca il target per lo scroll: slider o mosaico-grid
			let targetScrollElement = null;

			// Controlla se siamo su mobile (slider visibile)
			if (comprensoriMobileElement && window.getComputedStyle(comprensoriMobileElement).display !== "none" && sliderElement) {
				targetScrollElement = sliderElement;
			}
			// Controlla se siamo su desktop (mosaico-grid visibile)
			else if (comprensoriDesktopElement && window.getComputedStyle(comprensoriDesktopElement).display !== "none" && mosaicoGridElement) {
				targetScrollElement = mosaicoGridElement;
			}
			// Fallback: usa lo slider se esiste, altrimenti il mosaico-grid
			else if (sliderElement) {
				targetScrollElement = sliderElement;
			} else if (mosaicoGridElement) {
				targetScrollElement = mosaicoGridElement;
			}

			if (targetScrollElement) {
				window.scroll({
					top: targetScrollElement.offsetTop - 15,
					left: 0,
					behavior: "smooth"
				});
			}

			if (typeof fbq != "undefined") fbq("trackCustom", "click_cta-lasciati-ispirare-header", {
				lingua: currentLang
			});
		});

		acquistaHeaderElement.addEventListener("click", function (e) {
			const currentLang = getCurrentLang();
			usermaven("track", "click_cta-acquista-header", {
				lingua: currentLang
			});
			// evt ga4 impostato da tag mangager
			fbq("trackCustom", "click_cta-acquista-header", {
				lingua: currentLang
			});
		});

		acquistaComeElement.addEventListener("click", function (e) {
			const currentLang = getCurrentLang();
			usermaven("track", "click_cta-acquista-section-come", {
				lingua: currentLang
			});
			// evt ga4 impostato da tag mangager
			fbq("trackCustom", "click_cta-acquista-section-come", {
				lingua: currentLang
			});
		});

		acquistaCoseElement.addEventListener("click", function (e) {
			const currentLang = getCurrentLang();
			usermaven("track", "click_cta-acquista-section-cose", {
				lingua: currentLang
			});
			// evt ga4 impostato da tag mangager
			fbq("trackCustom", "click_cta-acquista-section-cose", {
				lingua: currentLang
			});
		});

		acquistaLasciatiIspirareElement.addEventListener("click", function (e) {
			const currentLang = getCurrentLang();
			usermaven("track", "click_cta-acquista-section-lasciati-ispirare", {
				lingua: currentLang
			});
			// evt ga4 impostato da tag mangager
			fbq("trackCustom", "click_cta-acquista-section-lasciati-ispirare", {
				lingua: currentLang
			});
		});

		footerTelLinkElement.addEventListener("click", function (e) {
			const currentLang = getCurrentLang();
			usermaven("track", "click_footer-tel-link", {
				lingua: currentLang
			});
			// evt ga4 impostato da tag mangager
			fbq("trackCustom", "click_footer-tel-link", {
				lingua: currentLang
			});
		});

		footerEmailLinkElement.addEventListener("click", function (e) {
			const currentLang = getCurrentLang();
			usermaven("track", "click_footer-email-link", {
				lingua: currentLang
			});
			dataLayer.push({
				event: "click_footer-email-link"
			});
			fbq("trackCustom", "click_footer-email-link", {
				lingua: currentLang
			});
		});
	</script>
</header>
